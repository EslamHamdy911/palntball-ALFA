<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON WARS: Rage Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ¥ÿßÿ¥ÿ© ŸàÿßŸÑŸÑŸÖÿ≥ */
        * { touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Orbitron', sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 10, 0.98);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            pointer-events: auto; z-index: 100;
        }
        
        h1 { color: #00f3ff; text-shadow: 0 0 20px #00f3ff; font-size: 35px; margin: 0; text-align: center;}
        p { color: #aaa; margin-top: 5px; font-size: 12px; }

        .btn {
            background: rgba(0, 243, 255, 0.1); border: 2px solid #00f3ff; color: #00f3ff;
            padding: 15px 40px; font-size: 20px; font-family: 'Orbitron', sans-serif;
            cursor: pointer; margin-top: 25px; text-transform: uppercase; width: 70%; border-radius: 10px;
            box-shadow: 0 0 15px #00f3ff; pointer-events: auto;
        }
        .btn:active { background: #00f3ff; color: #000; transform: scale(0.95); }

        /* ÿ≤ÿ± ÿßŸÑÿ∫ÿ∂ÿ® */
        #rage-btn {
            position: absolute; bottom: 120px; right: 20px;
            width: 80px; height: 80px; border-radius: 50%;
            background: radial-gradient(circle, #ff5500, #550000);
            border: 3px solid #ffaa00;
            color: #fff; font-weight: bold; font-size: 14px;
            display: none; /* ŸÖÿÆŸÅŸä ŸÅŸä ÿßŸÑÿ®ÿØÿßŸäÿ© */
            justify-content: center; align-items: center;
            box-shadow: 0 0 20px #ff5500;
            animation: pulseRage 0.5s infinite alternate;
            pointer-events: auto; cursor: pointer; z-index: 50;
        }
        @keyframes pulseRage { from { transform: scale(1); box-shadow: 0 0 20px #ff5500; } to { transform: scale(1.1); box-shadow: 0 0 40px #ff5500; } }

        #hud { padding: 15px; display: flex; justify-content: space-between; width: 90%; margin: 0 auto; text-shadow: 0 2px 5px rgba(0,0,0,0.8); font-size: 16px; font-weight: bold; }
        #wave-msg { position: absolute; top: 15%; width: 100%; text-align: center; color: #f1c40f; font-size: 24px; font-weight: bold; opacity: 0; transition: opacity 0.5s; text-shadow: 0 0 10px #f00; }
        
        /* ŸÖÿ§ŸÇÿ™ ÿßŸÑÿ∫ÿ∂ÿ® */
        #rage-timer { position: absolute; top: 60px; right: 20px; color: #555; font-size: 12px; }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1>NEON WARS</h1>
        <p>AUTO-FIRE EDITION</p>
        <button class="btn" onclick="startGame()">DEPLOY</button>
        <p style="margin-top: 20px; font-size: 10px; color: #666;">DRAG TO MOVE & AUTO-SHOOT</p>
    </div>

    <div id="win-screen" class="screen" style="display:none;">
        <h1 style="color:#f1c40f">LEGENDARY!</h1>
        <p>YOU SURVIVED THE HORDE</p>
        <button class="btn" onclick="location.reload()">REPLAY</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="hud">
            <div style="color:#00f3ff">KILLS: <span id="p-score">0</span></div>
            <div style="color:#ff0055">HP: <span id="p-hp">100</span>%</div>
        </div>
        <div id="wave-msg">WARNING</div>
        <div id="rage-timer">RAGE: <span id="r-time">0</span>%</div>
        
        <!-- ÿ≤ÿ± ÿßŸÑÿ∫ÿ∂ÿ® -->
        <div id="rage-btn" onclick="activateRage()">RAGE<br>READY</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        function resize() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
        }
        window.addEventListener('resize', resize); resize();

        // ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™
        let gameRunning = false;
        let score = 0;
        let frame = 0;
        
        let enemies = [], bullets = [], particles = [];
        let player;
        let shake = 0;
        
        // ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ
        let bossPhase = 0; // 0:ÿ®ÿØÿßŸäÿ©, 1:Ÿàÿ≠ÿ¥1, 2:ÿ™Ÿàÿ£ŸÖ, 3:ÿ≤ŸàŸÖÿ®Ÿä
        
        // ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ∫ÿ∂ÿ®
        let rageCharge = 0; // 0 ÿßŸÑŸâ 100
        let isRageActive = false;
        let rageDuration = 0;

        // ÿßŸÑŸÖÿØÿÆŸÑÿßÿ™ (ÿπÿµÿß Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑)
        const input = {
            active: false,
            startX: 0, startY: 0,
            x: 0, y: 0,
            dx: 0, dy: 0,
            id: null
        };

        // --- ÿßŸÑŸÉÿßÿ¶ŸÜÿßÿ™ ---
        class Agent {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type; 
                this.angle = 0;
                
                // ÿ™ŸÖ ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿ£ÿ≠ÿ¨ÿßŸÖ ŸÑÿ•ÿπÿ∑ÿßÿ° ŸÖÿ≥ÿßÿ≠ÿ© ÿ£ŸÉÿ®ÿ± (ÿ™ÿ£ÿ´Ÿäÿ± ÿ±ŸÅÿπ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß)
                if(type === 'player') {
                    this.radius = 15; // ÿ£ÿµÿ∫ÿ±
                    this.color = '#00f3ff'; 
                    this.speed = 4; 
                    this.hp = 200; // ÿµÿ≠ÿ© ÿ£ÿπŸÑŸâ ŸÑŸÑÿßÿπÿ® (ŸÑÿ•ÿ®ÿ∑ÿßÿ° ÿßŸÑŸÑÿπÿ®)
                    this.maxHp = 200;
                } else if (type === 'boss') {
                    this.radius = 40; 
                    this.color = '#f1c40f'; 
                    this.speed = 1.5; // ÿ£ÿ®ÿ∑ÿ£
                    this.hp = 500; // ÿµÿ≠ÿ© ÿπÿßŸÑŸäÿ© ÿ¨ÿØÿßŸã ŸÑŸÑŸàÿ≠ÿ¥
                    this.maxHp = 500;
                } else if (type === 'zombie') {
                    this.radius = 15;
                    this.color = '#00ff00'; // ÿ≤ŸàŸÖÿ®Ÿä ÿ£ÿÆÿ∂ÿ±
                    this.speed = 5; // ÿ≥ÿ±Ÿäÿπ ÿ¨ÿØÿßŸã
                    this.hp = 20; // ÿ∂ÿπŸäŸÅ
                } else { // enemy ÿπÿßÿØŸâ
                    this.radius = 15; 
                    this.color = '#ff0055'; 
                    this.speed = 2.5; 
                    this.hp = 40; // ÿµÿ≠ÿ© ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©
                }
            }

            update() {
                let dx=0, dy=0;
                
                if (this.type === 'player') {
                    // ÿ≠ÿ±ŸÉÿ© ÿßŸÑŸÑÿßÿπÿ®
                    if (input.active) {
                        dx = input.dx; dy = input.dy;
                        
                        // ÿßŸÑÿ™ÿµŸàŸäÿ® ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä (Auto-Aim)
                        // Ÿäÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸÇÿ±ÿ® ÿπÿØŸà
                        let nearest = null;
                        let minDst = 9999;
                        enemies.forEach(e => {
                            let d = Math.hypot(e.x - this.x, e.y - this.y);
                            if(d < minDst) { minDst = d; nearest = e; }
                        });

                        if(nearest && minDst < 400) {
                            // ÿµŸàÿ® ŸÜÿ≠Ÿà ÿßŸÑÿπÿØŸà
                            this.angle = Math.atan2(nearest.y - this.y, nearest.x - this.x);
                        } else if (dx || dy) {
                            // ÿ•ÿ∞ÿß ŸÑÿß ŸäŸàÿ¨ÿØ ÿπÿØŸàÿå ÿµŸàÿ® ŸÑŸÑÿ£ŸÖÿßŸÖ
                            this.angle = Math.atan2(dy, dx);
                        }

                        // ÿ•ÿ∑ŸÑÿßŸÇ ŸÜÿßÿ± ÿ™ŸÑŸÇÿßÿ¶Ÿä ÿπŸÜÿØ ÿßŸÑÿ≠ÿ±ŸÉÿ©
                        let rate = isRageActive ? 5 : 15; // ÿ≥ÿ±Ÿäÿπ ÿ¨ÿØÿßŸã ŸÅŸä ÿßŸÑÿ∫ÿ∂ÿ®
                        if(frame % rate === 0) shoot(this);
                    }
                } else {
                    // ÿ∞ŸÉÿßÿ° ÿßŸÑÿ£ÿπÿØÿßÿ° (Ÿäÿ∑ÿßÿ±ÿØŸàŸÜ ÿßŸÑŸÑÿßÿπÿ®)
                    let target = player;
                    let dist = Math.hypot(target.x - this.x, target.y - this.y);
                    this.angle = Math.atan2(target.y - this.y, target.x - this.x);

                    if(this.type === 'zombie') {
                        // ÿßŸÑÿ≤ŸàŸÖÿ®Ÿä Ÿäÿ±ŸÉÿ∂ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÜÿ≠Ÿà ÿßŸÑŸÑÿßÿπÿ® ŸÑÿ∂ÿ±ÿ®Ÿá
                        dx = Math.cos(this.angle); dy = Math.sin(this.angle);
                        // ÿ∂ÿ±ÿ± ÿßŸÑÿ≤ŸàŸÖÿ®Ÿä ÿπŸÜÿØ ÿßŸÑÿ™ŸÑÿßŸÖÿ≥
                        if(dist < this.radius + target.radius) {
                            player.hp -= 0.5; // ÿ∂ÿ±ÿ± ŸÖÿ≥ÿ™ŸÖÿ± ÿπŸÜÿØ ÿßŸÑÿ™ŸÑÿßŸÖÿ≥
                            createExplosion(this.x, this.y, '#f00', 2);
                        }
                    } else {
                        // ÿßŸÑÿ£ÿπÿØÿßÿ° ÿßŸÑÿπÿßÿØŸäŸäŸÜ Ÿäÿ∑ŸÑŸÇŸàŸÜ ÿßŸÑŸÜÿßÿ± ŸàŸäÿ®ÿ™ÿπÿØŸàŸÜ ŸÇŸÑŸäŸÑÿßŸã
                        let stopDist = (this.type === 'boss') ? 250 : 150;
                        if(dist > stopDist) { dx = Math.cos(this.angle); dy = Math.sin(this.angle); }
                        else if(dist < stopDist - 50) { dx = -Math.cos(this.angle); dy = -Math.sin(this.angle); }

                        // ÿ•ÿ∑ŸÑÿßŸÇ ŸÜÿßÿ±
                        let shootProb = (this.type === 'boss') ? 0.03 : 0.01; // ŸÇŸÑŸÑŸÜÿß ÿßÿ≠ÿ™ŸÖÿßŸÑŸäÿ© ÿßŸÑÿ•ÿ∑ŸÑÿßŸÇ
                        if(Math.random() < shootProb) shoot(this);
                    }

                    // ŸÖŸÜÿπ ÿ™ÿØÿßÿÆŸÑ ÿßŸÑŸàÿ≠Ÿàÿ¥
                    enemies.forEach(other => {
                        if(other !== this && Math.hypot(this.x - other.x, this.y - other.y) < this.radius + other.radius) {
                            dx += (this.x - other.x) * 0.05; dy += (this.y - other.y) * 0.05;
                        }
                    });
                }

                this.x += dx * this.speed; this.y += dy * this.speed;
                this.x = Math.max(20, Math.min(width-20, this.x));
                this.y = Math.max(20, Math.min(height-20, this.y));
            }

            draw() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                
                // ŸÑŸàŸÜ ÿßŸÑÿ∫ÿ∂ÿ® ŸÑŸÑÿßÿπÿ®
                let drawColor = (this.type === 'player' && isRageActive) ? '#ff4400' : this.color;
                
                ctx.shadowBlur = 10; ctx.shadowColor = drawColor;
                ctx.fillStyle = drawColor; 
                ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fill();
                
                // ÿ™ŸÅÿßÿµŸäŸÑ
                ctx.shadowBlur = 0; ctx.fillStyle = '#111';
                
                if(this.type === 'boss') {
                    // ÿßŸÑŸàÿ≠ÿ¥ (4 ŸÖÿØÿßŸÅÿπ + ŸÖÿØŸÅÿπ Ÿàÿ≥ÿ∑)
                    ctx.fillRect(10, -25, 30, 8); ctx.fillRect(10, 17, 30, 8);
                    ctx.fillRect(5, -35, 20, 8); ctx.fillRect(5, 27, 20, 8);
                    ctx.fillRect(10, -10, 40, 20); // Ÿàÿ≥ÿ∑
                    // ÿ®ÿßÿ± ÿµÿ≠ÿ© ÿßŸÑŸàÿ≠ÿ¥
                    ctx.fillStyle = 'red'; ctx.fillRect(-30, -50, 60, 4);
                    ctx.fillStyle = '#0f0'; ctx.fillRect(-30, -50, 60 * (this.hp/this.maxHp), 4);
                } else if(this.type === 'zombie') {
                     // ÿ¥ŸÉŸÑ ÿßŸÑÿ≤ŸàŸÖÿ®Ÿä (ŸÖÿÆŸäŸÅ ŸÇŸÑŸäŸÑÿßŸã)
                     ctx.beginPath(); ctx.arc(5, -5, 4, 0, Math.PI*2); ctx.fill(); // ÿπŸäŸÜ 1
                     ctx.beginPath(); ctx.arc(5, 5, 4, 0, Math.PI*2); ctx.fill(); // ÿπŸäŸÜ 2
                } else {
                    // ÿπÿØŸà ÿπÿßÿØŸä
                    ctx.fillRect(5, -5, 15, 10);
                }
                ctx.restore();
            }
        }

        function spawnEnemy(type = 'enemy', xOffset = 0) {
            let startX = width/2 + xOffset;
            let startY = -50; // Ÿäÿ£ÿ™Ÿä ŸÖŸÜ ÿßŸÑÿ£ÿπŸÑŸâ
            if(type === 'zombie') {
                // ÿßŸÑÿ≤ŸàŸÖÿ®Ÿä Ÿäÿ£ÿ™Ÿä ŸÖŸÜ ŸÉŸÑ ŸÖŸÉÿßŸÜ
                startX = Math.random() < 0.5 ? -20 : width+20;
                startY = Math.random() * height;
            }
            let e = new Agent(startX, startY, type);
            enemies.push(e);
        }

        function shoot(s) {
            let shots = [];
            
            if(s.type === 'player') {
                if(isRageActive) {
                    // ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ∫ÿ∂ÿ®: 3 ÿ±ÿµÿßÿµÿßÿ™
                    shots.push(s.angle); 
                    shots.push(s.angle - 0.2); 
                    shots.push(s.angle + 0.2);
                } else {
                    shots.push(s.angle);
                }
            } else if(s.type === 'boss') {
                // ÿßŸÑŸàÿ≠ÿ¥ Ÿäÿ∑ŸÑŸÇ 3 ÿ±ÿµÿßÿµÿßÿ™
                shots.push(s.angle);
                shots.push(s.angle - 0.3);
                shots.push(s.angle + 0.3);
            } else {
                shots.push(s.angle + (Math.random()-0.5)*0.1);
            }

            shots.forEach(a => {
                let size = (s.type === 'player' && isRageActive) ? 6 : 3;
                let dmg = (s.type === 'player') ? (isRageActive ? 20 : 5) : 5; // ÿ∂ÿ±ÿ± ÿßŸÑŸÑÿßÿπÿ® 5 (ÿ®ÿ∑Ÿäÿ°)
                
                bullets.push({
                    x: s.x, y: s.y, 
                    vx: Math.cos(a)*10, vy: Math.sin(a)*10, 
                    color: (s.type === 'player' && isRageActive) ? '#ff4400' : s.color, 
                    owner: s.type === 'player' ? 'p' : 'e',
                    size: size,
                    damage: dmg
                });
            });
        }

        function createExplosion(x, y, color, count=10) {
            for(let i=0; i<count; i++) particles.push({x, y, vx:(Math.random()-0.5)*8, vy:(Math.random()-0.5)*8, life:1, color});
        }

        function showMsg(text) {
            let el = document.getElementById('wave-msg'); el.innerText = text; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 3000);
        }

        // --- ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ∫ÿ∂ÿ® ---
        function activateRage() {
            if(rageCharge < 100) return;
            isRageActive = true;
            rageDuration = 600; // 10 ÿ´ŸàÿßŸÜŸä (60 ŸÅÿ±ŸäŸÖ * 10)
            rageCharge = 0;
            document.getElementById('rage-btn').style.display = 'none';
            showMsg("üî•üî• RAGE UNLEASHED üî•üî•");
            createExplosion(player.x, player.y, '#ff4400', 50);
            
            // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿ≠ÿ¥ÿØ ÿßŸÑÿ≤ŸàŸÖÿ®Ÿä
            for(let i=0; i<8; i++) setTimeout(() => spawnEnemy('zombie'), i*500);
        }

        function updateRage() {
            if(isRageActive) {
                rageDuration--;
                if(rageDuration <= 0) {
                    isRageActive = false;
                    player.color = '#00f3ff';
                }
            } else {
                // ÿ¥ÿ≠ŸÜ ÿßŸÑÿ∫ÿ∂ÿ® ŸÉŸÑ ÿØŸÇŸäŸÇÿ© (60 ÿ´ÿßŸÜŸäÿ© = 3600 ŸÅÿ±ŸäŸÖ)
                // ŸÜÿ≤ŸäÿØ ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿ®ÿ®ÿ∑ÿ°
                if(rageCharge < 100) rageCharge += (100 / 3600);
                
                document.getElementById('r-time').innerText = Math.floor(rageCharge);
                
                if(rageCharge >= 100) {
                    document.getElementById('rage-btn').style.display = 'flex';
                }
            }
        }

        // --- ŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ™ŸÇÿØŸÖ ---
        function checkProgression() {
            // ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© 1: Ÿàÿ≠ÿ¥ 1 ÿπŸÜÿØ 100 ŸÜŸÇÿ∑ÿ©
            if(score >= 100 && bossPhase === 0) {
                bossPhase = 1; showMsg("‚ö†Ô∏è BOSS DETECTED ‚ö†Ô∏è");
                enemies = []; setTimeout(() => spawnEnemy('boss'), 1000);
            }
            
            // ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© 2: ÿßŸÑÿ™Ÿàÿ£ŸÖ ÿ®ÿπÿØ ŸÖŸàÿ™ ÿßŸÑŸàÿ≠ÿ¥ ÿßŸÑÿ£ŸàŸÑ
            if(bossPhase === 1 && enemies.length === 0) {
                bossPhase = 2; showMsg("‚ö†Ô∏è THE TWINS ‚ö†Ô∏è");
                setTimeout(() => { spawnEnemy('boss', -50); spawnEnemy('boss', 50); }, 2000);
            }

            // ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© 3: ÿßŸÑÿ≤ŸàŸÖÿ®Ÿä ÿ®ÿπÿØ ŸÖŸàÿ™ ÿßŸÑÿ™Ÿàÿ£ŸÖ (ŸÅŸàŸÇ 250 ŸÜŸÇÿ∑ÿ©)
            if(bossPhase === 2 && score > 250 && enemies.length === 0) {
                bossPhase = 3; showMsg("‚ò£Ô∏è ZOMBIE HORDE ‚ò£Ô∏è");
            }

            // ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≤ŸàŸÖÿ®Ÿä ŸàÿßŸÑÿ£ÿπÿØÿßÿ°
            let maxEnemies = 3 + Math.floor(score/100);
            if(enemies.length < maxEnemies && bossPhase !== 1 && bossPhase !== 2) {
                if(bossPhase === 3) {
                    if(Math.random() < 0.05) spawnEnemy('zombie');
                } else {
                    if(Math.random() < 0.03) spawnEnemy('enemy');
                }
            }
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            player = new Agent(width/2, height-100, 'player');
            enemies = []; bullets = []; score = 0; bossPhase = 0; rageCharge = 0;
            spawnEnemy(); gameRunning = true; loop();
        }

        function loop() {
            if(!gameRunning) return;
            requestAnimationFrame(loop); frame++;
            
            if(shake > 0) { ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); shake *= 0.9; }

            // ÿßŸÑÿÆŸÑŸÅŸäÿ©
            ctx.fillStyle = '#050505'; ctx.fillRect(0,0,width,height);
            // ÿ¥ÿ®ŸÉÿ© Ÿàÿßÿ≥ÿπÿ© (ÿ™ÿ£ÿ´Ÿäÿ± Zoom Out)
            ctx.strokeStyle = 'rgba(0, 243, 255, 0.05)'; ctx.lineWidth = 1; ctx.beginPath();
            for(let i=0; i<width; i+=80) { ctx.moveTo(i,0); ctx.lineTo(i,height); }
            for(let i=0; i<height; i+=80) { ctx.moveTo(0,i); ctx.lineTo(width,i); }
            ctx.stroke();

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∫ÿ∂ÿ®
            updateRage();

            // ÿ±ÿ≥ŸÖ ÿßŸÑÿ¨ÿ≤Ÿäÿ¶ÿßÿ™
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; if(p.life<=0) particles.splice(i,1);
            }

            // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿ±ÿ≥ŸÖ ÿßŸÑŸÉÿßÿ¶ŸÜÿßÿ™
            if(player) player.update(); player.draw();
            enemies.forEach(e => { e.update(); e.draw(); });

            // ÿßŸÑÿ±ÿµÿßÿµ
            for(let i=bullets.length-1; i>=0; i--) {
                let b = bullets[i]; b.x += b.vx; b.y += b.vy;
                ctx.strokeStyle = b.color; ctx.lineWidth = b.size; ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(b.x-b.vx, b.y-b.vy); ctx.stroke();
                
                if(b.x<0||b.x>width||b.y<0||b.y>height) { bullets.splice(i,1); continue; }

                let targets = (b.owner === 'p') ? enemies : [player];
                for(let t of targets) {
                    if(Math.hypot(b.x-t.x, b.y-t.y) < t.radius+5) {
                        createExplosion(t.x, t.y, b.color, 3);
                        if(b.owner === 'p') {
                            t.hp -= b.damage; // ÿ∂ÿ±ÿ± ÿ®ÿ∑Ÿäÿ°
                            if(t.hp <= 0) {
                                score += (t.type==='boss'?50:1); 
                                createExplosion(t.x, t.y, '#fff', 10);
                                enemies = enemies.filter(e => e !== t);
                                checkProgression();
                            }
                        } else {
                            // ÿ∂ÿ±ÿ± ÿßŸÑŸÑÿßÿπÿ®
                            player.hp -= 2; 
                            shake = 5;
                            if(player.hp <= 0) location.reload(); // ÿÆÿ≥ÿßÿ±ÿ©
                        }
                        bullets.splice(i,1); break;
                    }
                }
            }

            // Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            document.getElementById('p-score').innerText = score;
            document.getElementById('p-hp').innerText = Math.max(0, Math.floor((player.hp/player.maxHp)*100));

            // ÿ±ÿ≥ŸÖ ÿπÿµÿß ÿßŸÑÿ™ÿ≠ŸÉŸÖ
            if (input.active) {
                ctx.beginPath(); ctx.arc(input.startX, input.startY, 40, 0, Math.PI*2);
                ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.stroke();
                ctx.beginPath(); ctx.arc(input.x, input.y, 20, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(0, 243, 255, 0.4)'; ctx.fill();
            }

            ctx.restore();
        }

        // --- ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ÿßŸÑŸÑŸÖÿ≥ (ÿ≤ÿ± Ÿàÿßÿ≠ÿØ ŸÑŸÑÿ≠ÿ±ŸÉÿ© ŸàÿßŸÑÿ•ÿ∑ŸÑÿßŸÇ) ---
        window.addEventListener('touchstart', e => {
            // ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿ∂ÿ∫ÿ∑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± (ŸÖÿ´ŸÑ Rage)
            if(e.target.tagName === 'BUTTON' || e.target.id === 'rage-btn') return;
            e.preventDefault();
            
            // ŸÜÿ£ÿÆÿ∞ ÿßŸÑŸÑŸÖÿ≥ÿ© ÿßŸÑÿ£ŸàŸÑŸâ ŸÅŸÇÿ∑ ŸÑŸÑÿ™ÿ≠ŸÉŸÖ
            if(!input.active) {
                let t = e.changedTouches[0];
                input.active = true;
                input.id = t.identifier;
                input.startX = t.clientX; input.startY = t.clientY;
                input.x = t.clientX; input.y = t.clientY;
                input.dx = 0; input.dy = 0;
            }
        }, {passive: false});

        window.addEventListener('touchmove', e => {
            if(e.target.tagName !== 'BUTTON') e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++) {
                let t = e.changedTouches[i];
                if(input.active && t.identifier === input.id) {
                    let dx = t.clientX - input.startX;
                    let dy = t.clientY - input.startY;
                    let dist = Math.min(40, Math.hypot(dx, dy));
                    let angle = Math.atan2(dy, dx);
                    
                    input.x = input.startX + Math.cos(angle) * dist;
                    input.y = input.startY + Math.sin(angle) * dist;
                    
                    // ÿ™ÿ∑ÿ®Ÿäÿπ ÿßŸÑŸÇŸäŸÖ ŸÑŸÑÿ≠ÿ±ŸÉÿ©
                    input.dx = Math.cos(angle) * (dist/40);
                    input.dy = Math.sin(angle) * (dist/40);
                }
            }
        }, {passive: false});

        window.addEventListener('touchend', e => {
             if(e.target.tagName !== 'BUTTON') e.preventDefault();
             for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === input.id) {
                    input.active = false; input.dx = 0; input.dy = 0;
                }
             }
        }, {passive: false});

    </script>
</body>
</html>
