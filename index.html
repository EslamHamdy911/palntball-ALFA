<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON WARS: Infinite</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Orbitron', sans-serif; }
        canvas { display: block; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 10, 0.98);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; pointer-events: auto; z-index: 100;
        }
        
        h1 { color: #00f3ff; text-shadow: 0 0 20px #00f3ff; font-size: 40px; text-align: center; margin: 0; }
        p { color: #aaa; margin-top: 5px; font-size: 14px; text-align: center; }

        .btn {
            background: transparent; border: 2px solid #00f3ff; color: #00f3ff;
            padding: 15px 40px; font-size: 18px; font-family: 'Orbitron', sans-serif;
            cursor: pointer; margin-top: 20px; text-transform: uppercase; width: 250px;
            box-shadow: 0 0 10px #00f3ff; transition: 0.2s;
        }
        .btn:active { background: #00f3ff; color: #000; }
        .btn-green { border-color: #0f0; color: #0f0; box-shadow: 0 0 10px #0f0; }
        .btn-green:active { background: #0f0; }

        #hud { padding: 15px; display: flex; justify-content: space-between; width: 90%; margin: 0 auto; text-shadow: 0 2px 5px rgba(0,0,0,0.8); font-size: 18px; font-weight: bold; }
        
        #wave-msg {
            position: absolute; top: 20%; width: 100%; text-align: center;
            color: #f1c40f; font-size: 30px; font-weight: bold; opacity: 0; transition: opacity 0.5s;
        }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­ÙØ¸ */
        #save-icon {
            position: absolute; top: 20px; right: 20px; font-size: 20px; display: none;
            color: #0f0; text-shadow: 0 0 5px #0f0;
        }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1>NEON WARS</h1>
        <p>SYSTEM READY</p>
        
        <!-- Ø²Ø± Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù„Ø¹Ø¨ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø­ÙØ¸ -->
        <button id="btn-continue" class="btn btn-green" onclick="loadAndStart()" style="display:none;">CONTINUE (LVL <span id="saved-lvl">0</span>)</button>
        
        <button class="btn" onclick="startNewGame()">NEW GAME</button>
        
        <p style="margin-top: 30px; font-size: 10px; color: #555;">AUTO-SAVE ENABLED</p>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="hud">
            <div style="color:#00f3ff">SCORE: <span id="p-score">0</span></div>
            <div style="color:#f1c40f">LEVEL: <span id="p-level">1</span></div>
        </div>
        <div id="wave-msg">LEVEL 1</div>
        <div id="save-icon">ğŸ’¾ SAVING...</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        function resize() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
        }
        window.addEventListener('resize', resize); resize();

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§
        let gameData = {
            level: 1,
            score: 0,
            fireRate: 20, // Ø³Ø±Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ø­
            unlockedWeapons: 1
        };

        let gameRunning = false;
        let frame = 0;
        let enemies = [];
        let bullets = [];
        let particles = [];
        let shake = 0;
        let bossActive = false;
        
        const house = { x: 0, y: 60 };

        const input = {
            joystick: { active: false, x: 0, y: 0, dx: 0, dy: 0, id: null },
            fireBtn: { active: false, x: 0, y: 0, id: null },
            keys: { w:false, a:false, s:false, d:false },
            mouse: { x: 0, y: 0, down: false },
            isMobile: false
        };

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ (Save System) ---
        function saveGame() {
            localStorage.setItem('neonWarsSave_v1', JSON.stringify(gameData));
            // Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­ÙØ¸
            let icon = document.getElementById('save-icon');
            icon.style.display = 'block';
            setTimeout(() => icon.style.display = 'none', 1500);
        }

        function checkSaveFile() {
            let data = localStorage.getItem('neonWarsSave_v1');
            if(data) {
                let parsed = JSON.parse(data);
                document.getElementById('btn-continue').style.display = 'block';
                document.getElementById('saved-lvl').innerText = parsed.level;
            }
        }

        function startNewGame() {
            // ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            gameData = { level: 1, score: 0, fireRate: 20, unlockedWeapons: 1 };
            saveGame(); // Ø­ÙØ¸ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            initLevel();
        }

        function loadAndStart() {
            let data = localStorage.getItem('neonWarsSave_v1');
            if(data) {
                gameData = JSON.parse(data);
                initLevel();
            }
        }

        // --- Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª ---
        class Agent {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type; 
                this.angle = 0;
                
                if(type === 'player') {
                    this.radius = 20; this.color = '#00f3ff'; this.speed = 4.5; this.hp = 100;
                } else if (type === 'boss') {
                    this.radius = 50; this.color = '#f1c40f'; this.speed = 2 + (gameData.level * 0.1); // ÙŠØ³Ø±Ø¹ ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰
                    this.hp = 150 + (gameData.level * 50); // ØªØ²ÙŠØ¯ Ø§Ù„ØµØ­Ø© ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰
                } else { 
                    this.radius = 20; this.color = '#ff0055'; this.speed = 3 + (gameData.level * 0.05); 
                    this.hp = 1 + Math.floor(gameData.level / 5); // ÙŠØµØ¨Ø­ÙˆÙ† Ø£Ù‚ÙˆÙ‰
                }
            }

            update(target) {
                let dx=0, dy=0;
                if (this.type === 'player') {
                    if (input.joystick.active) { dx = input.joystick.dx; dy = input.joystick.dy; }
                    else {
                        if(input.keys.w) dy = -1; if(input.keys.s) dy = 1;
                        if(input.keys.a) dx = -1; if(input.keys.d) dx = 1;
                    }
                    if (input.isMobile) { if(dx||dy) this.angle = Math.atan2(dy, dx); }
                    else {
                        this.angle = Math.atan2(input.mouse.y - this.y, input.mouse.x - this.x);
                        if(input.mouse.down && frame % gameData.fireRate === 0) shoot(this);
                    }
                    if (input.isMobile && input.fireBtn.active && frame % gameData.fireRate === 0) shoot(this);
                } else {
                    let dist = Math.hypot(target.x - this.x, target.y - this.y);
                    this.angle = Math.atan2(target.y - this.y, target.x - this.x);
                    let stopDist = (this.type === 'boss') ? 200 : 120;
                    if(dist > stopDist) { dx = Math.cos(this.angle); dy = Math.sin(this.angle); }
                    else if(dist < stopDist - 50) { dx = -Math.cos(this.angle); dy = -Math.sin(this.angle); }
                    
                    enemies.forEach(other => {
                        if(other !== this) {
                            let d = Math.hypot(this.x - other.x, this.y - other.y);
                            if(d < this.radius + other.radius) {
                                dx += (this.x - other.x) / d; dy += (this.y - other.y) / d;
                            }
                        }
                    });
                    
                    // Ø§Ù„ÙˆØ­Ø´ ÙŠØ·Ù„Ù‚ Ø£Ø³Ø±Ø¹ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
                    let shootProb = (this.type === 'boss') ? 0.03 + (gameData.level*0.001) : 0.02;
                    if(Math.random() < shootProb) shoot(this);
                }
                this.x += dx * this.speed; this.y += dy * this.speed;
                this.x = Math.max(20, Math.min(width-20, this.x));
                this.y = Math.max(20, Math.min(height-20, this.y));
            }

            draw() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                ctx.shadowBlur = 15; ctx.shadowColor = this.color;
                ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fill();
                
                ctx.shadowBlur = 0; ctx.fillStyle = '#111';
                if(this.type === 'boss') {
                    ctx.fillRect(15, -30, 40, 60); 
                    ctx.beginPath(); ctx.arc(0, 0, 30, 0, Math.PI*2); ctx.fill();
                    // Ø´Ø±ÙŠØ· Ø­ÙŠØ§Ø©
                    let maxHp = 150 + (gameData.level * 50);
                    ctx.fillStyle = 'red'; ctx.fillRect(-40, -70, 80, 5);
                    ctx.fillStyle = '#0f0'; ctx.fillRect(-40, -70, 80 * (this.hp/maxHp), 5);
                } else {
                    ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI*2); ctx.fill();
                    ctx.fillRect(5, -5, 20, 10);
                }
                ctx.restore();
            }
        }

        let player;

        function spawnEnemy(type = 'enemy') {
            let e = new Agent(width/2, 100, type);
            enemies.push(e);
            createExplosion(e.x, 80, e.color);
        }

        function showMsg(text) {
            let el = document.getElementById('wave-msg');
            el.innerText = text; el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 3000);
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø°ÙƒÙŠ ---
        function checkProgression() {
            // ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰ ÙŠØ­ØªØ§Ø¬ Ù‚ØªÙ„Ø§Øª ØªØ³Ø§ÙˆÙŠ (Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰ * 20)
            // Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1 ÙŠØ­ØªØ§Ø¬ 20 Ù‚ØªÙ„Ø©ØŒ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2 ÙŠØ­ØªØ§Ø¬ 40 Ù‚ØªÙ„Ø© Ø¥Ø¶Ø§ÙÙŠØ©...
            let threshold = gameData.level * 25;
            
            // Ù‡Ù„ ÙˆØµÙ„Ù†Ø§ Ù„Ù„ÙˆØ­Ø´ØŸ
            if(gameData.score % threshold === 0 && !bossActive && gameData.score > 0) {
                bossActive = true;
                showMsg(`âš ï¸ LEVEL ${gameData.level} BOSS âš ï¸`);
                enemies = []; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø§Ù„ØµØºØ§Ø± Ù„Ù„Ù…Ø¨Ø§Ø±Ø²Ø©
                setTimeout(() => spawnEnemy('boss'), 1000);
            }

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ† (ÙŠØ²Ø¯Ø§Ø¯ Ø¹Ø¯Ø¯Ù‡Ù… ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰)
            let maxEnemies = 2 + Math.floor(gameData.level / 2);
            if(!bossActive && enemies.length < maxEnemies) {
                if(Math.random() < 0.05) spawnEnemy();
            }
        }

        function handleBossDeath() {
            // Ø¹Ù†Ø¯ Ù‚ØªÙ„ Ø§Ù„ÙˆØ­Ø´
            gameData.level++; // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰
            
            // Ù…ÙƒØ§ÙØ£Ø©: Ø²ÙŠØ§Ø¯Ø© Ø³Ø±Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ø­ ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰ (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰)
            if(gameData.fireRate > 5) gameData.fireRate--;
            
            bossActive = false;
            showMsg(`LEVEL ${gameData.level} START`);
            saveGame(); // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… Ù‡Ù†Ø§!
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('p-level').innerText = gameData.level;
        }

        function shoot(s) {
            let shots = [];
            if(s.type === 'boss') {
                // Ø§Ù„ÙˆØ­Ø´ ÙŠØ·Ù„Ù‚ Ø±ØµØ§ØµØ§Øª Ø¨Ø¹Ø¯Ø¯ Ù…Ø³ØªÙˆØ§Ù‡ (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 8 Ø§ØªØ¬Ø§Ù‡Ø§Øª)
                let count = Math.min(8, 2 + Math.floor(gameData.level/2));
                for(let i=0; i<count; i++) {
                    shots.push(s.angle + (i - count/2) * 0.2);
                }
            } else {
                shots.push(s.angle + (Math.random()-0.5)*0.1);
            }
            shots.forEach(a => {
                bullets.push({
                    x: s.x, y: s.y, vx: Math.cos(a)*12, vy: Math.sin(a)*12, 
                    color: s.color, owner: s.type === 'player' ? 'p' : 'e'
                });
            });
        }

        function createExplosion(x, y, color) {
            shake = 10;
            for(let i=0; i<15; i++) particles.push({x, y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:1, color});
        }

        function drawHouse() {
            let hx = width/2 - 50;
            ctx.shadowBlur = 30; ctx.shadowColor = '#00f3ff';
            ctx.fillStyle = '#0a0a1a'; ctx.fillRect(hx, house.y, 100, 60);
            ctx.beginPath(); ctx.moveTo(hx, house.y); ctx.lineTo(hx+50, house.y-40); ctx.lineTo(hx+100, house.y); ctx.fill();
            ctx.fillStyle = bossActive ? '#f00' : '#00f3ff'; ctx.fillRect(hx+35, house.y+20, 30, 40);
            ctx.shadowBlur = 0;
        }

        function initLevel() {
            document.getElementById('start-screen').style.display = 'none';
            player = new Agent(width/2, height-150, 'player');
            enemies = []; bullets = []; 
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('p-score').innerText = gameData.score;
            document.getElementById('p-level').innerText = gameData.level;
            
            showMsg(`LEVEL ${gameData.level}`);
            
            bossActive = false;
            gameRunning = true;
            spawnEnemy();
            loop();
        }

        function loop() {
            if(!gameRunning) return;
            requestAnimationFrame(loop);
            frame++;

            if(shake > 0) { ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); shake *= 0.9; }

            ctx.fillStyle = '#050505'; ctx.fillRect(0,0,width,height);
            ctx.strokeStyle = 'rgba(0, 243, 255, 0.05)'; ctx.lineWidth = 1; ctx.beginPath();
            for(let i=0; i<width; i+=60) { ctx.moveTo(i,0); ctx.lineTo(i,height); }
            for(let i=0; i<height; i+=60) { ctx.moveTo(0,i); ctx.lineTo(width,i); }
            ctx.stroke();

            drawHouse();

            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1; if(p.life<=0) particles.splice(i,1);
            }

            if (input.isMobile) {
                if (input.joystick.active) {
                    ctx.beginPath(); ctx.arc(input.joystick.x, input.joystick.y, 40, 0, Math.PI*2);
                    ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.stroke();
                    ctx.beginPath(); ctx.arc(input.joystick.x + input.joystick.dx*40, input.joystick.y + input.joystick.dy*40, 20, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(0, 243, 255, 0.5)'; ctx.fill();
                }
                if (input.fireBtn.active) {
                    ctx.beginPath(); ctx.arc(input.fireBtn.x, input.fireBtn.y, 35, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(255, 0, 85, 0.5)'; ctx.fill();
                }
            }

            if(player) player.update({});
            player.draw();

            enemies.forEach(e => { e.update(player); e.draw(); });

            for(let i=bullets.length-1; i>=0; i--) {
                let b = bullets[i]; b.x += b.vx; b.y += b.vy;
                ctx.strokeStyle = b.color; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(b.x-b.vx, b.y-b.vy); ctx.stroke();

                if(b.x<0||b.x>width||b.y<0||b.y>height) { bullets.splice(i,1); continue; }

                let targets = (b.owner === 'p') ? enemies : [player];
                for(let t of targets) {
                    if(Math.hypot(b.x-t.x, b.y-t.y) < t.radius+5) {
                        createExplosion(t.x, t.y, b.color);
                        if(b.owner === 'p') {
                            t.hp -= 10;
                            if(t.hp <= 0) {
                                gameData.score++;
                                document.getElementById('p-score').innerText = gameData.score;
                                
                                createExplosion(t.x, t.y, '#fff');
                                if(t.type === 'boss') {
                                    enemies = enemies.filter(e => e !== t);
                                    handleBossDeath();
                                } else {
                                    t.x = width/2; t.y = 80; t.hp = 1 + Math.floor(gameData.level/5);
                                    checkProgression();
                                }
                            }
                        }
                        bullets.splice(i,1); break;
                    }
                }
            }
            ctx.restore();
        }

        // Inputs
        window.addEventListener('touchstart', e => { e.preventDefault(); input.isMobile = true; for(let i=0; i<e.changedTouches.length; i++){ let t = e.changedTouches[i]; if(t.clientX < width/2){ input.joystick.active = true; input.joystick.id = t.identifier; input.joystick.x = t.clientX; input.joystick.y = t.clientY; } else { input.fireBtn.active = true; input.fireBtn.id = t.identifier; input.fireBtn.x = t.clientX; input.fireBtn.y = t.clientY; } } }, {passive: false});
        window.addEventListener('touchmove', e => { e.preventDefault(); for(let i=0; i<e.changedTouches.length; i++){ let t = e.changedTouches[i]; if(input.joystick.active && t.identifier === input.joystick.id){ let dx = t.clientX - input.joystick.x, dy = t.clientY - input.joystick.y; let dist = Math.min(50, Math.hypot(dx, dy)); let ang = Math.atan2(dy, dx); input.joystick.dx = (Math.cos(ang)*dist)/50; input.joystick.dy = (Math.sin(ang)*dist)/50; } if(input.fireBtn.active && t.identifier === input.fireBtn.id){ input.fireBtn.x = t.clientX; input.fireBtn.y = t.clientY; } } }, {passive: false});
        window.addEventListener('touchend', e => { e.preventDefault(); for(let i=0; i<e.changedTouches.length; i++){ if(e.changedTouches[i].identifier === input.joystick.id){ input.joystick.active = false; input.joystick.dx=0; input.joystick.dy=0; } if(e.changedTouches[i].identifier === input.fireBtn.id) input.fireBtn.active = false; } }, {passive: false});
        window.addEventListener('keydown', e => { let k=e.key.toLowerCase(); if(k==='w')input.keys.w=true; if(k==='s')input.keys.s=true; if(k==='a')input.keys.a=true; if(k==='d')input.keys.d=true; });
        window.addEventListener('keyup', e => { let k=e.key.toLowerCase(); if(k==='w')input.keys.w=false; if(k==='s')input.keys.s=false; if(k==='a')input.keys.a=false; if(k==='d')input.keys.d=false; });
        window.addEventListener('mousemove', e => { input.mouse.x = e.clientX; input.mouse.y = e.clientY; });
        window.addEventListener('mousedown', () => input.mouse.down = true);
        window.addEventListener('mouseup', () => input.mouse.down = false);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨Ø©
        checkSaveFile();
    </script>
</body>
</html>
