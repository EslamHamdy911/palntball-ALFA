<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON WARS: Mobile Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ§Ù„ØªÙƒØ¨ÙŠØ± */
        * {
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            outline: none;
            -webkit-tap-highlight-color: transparent; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø£Ø²Ø±Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³ */
        }

        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Orbitron', sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 10, 0.98);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            pointer-events: auto; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù„Ù…Ø³ Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
            z-index: 100;
        }
        
        h1 { color: #00f3ff; text-shadow: 0 0 20px #00f3ff; font-size: 40px; text-align: center; margin: 0; }
        p { color: #aaa; margin-top: 5px; font-size: 14px; text-align: center; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø²Ø± Ù„ÙŠÙƒÙˆÙ† ÙƒØ¨ÙŠØ±Ø§Ù‹ ÙˆØ³Ù‡Ù„ Ø§Ù„Ù„Ù…Ø³ */
        .btn {
            background: rgba(0, 243, 255, 0.1); 
            border: 2px solid #00f3ff; color: #00f3ff;
            padding: 20px 50px; font-size: 22px; font-family: 'Orbitron', sans-serif;
            cursor: pointer; margin-top: 30px; text-transform: uppercase; width: 80%; max-width: 300px;
            box-shadow: 0 0 15px #00f3ff; border-radius: 10px;
            pointer-events: auto; /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ */
        }
        .btn:active { background: #00f3ff; color: #000; transform: scale(0.95); }
        .btn-green { border-color: #0f0; color: #0f0; box-shadow: 0 0 10px #0f0; background: rgba(0, 255, 0, 0.1); }
        .btn-green:active { background: #0f0; }

        #hud { padding: 15px; display: flex; justify-content: space-between; width: 90%; margin: 0 auto; text-shadow: 0 2px 5px rgba(0,0,0,0.8); font-size: 18px; font-weight: bold; }
        #wave-msg { position: absolute; top: 20%; width: 100%; text-align: center; color: #f1c40f; font-size: 30px; font-weight: bold; opacity: 0; transition: opacity 0.5s; }
        #save-icon { position: absolute; top: 20px; right: 20px; font-size: 20px; display: none; color: #0f0; text-shadow: 0 0 5px #0f0; }
        
        /* Ø®Ø· ÙØ§ØµÙ„ ÙˆÙ‡Ù…ÙŠ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ Ù„Ù„ØªÙˆØ¶ÙŠØ­ */
        #divider {
            position: absolute; left: 50%; top: 90%; transform: translateX(-50%);
            color: rgba(255,255,255,0.2); font-size: 10px; text-align: center;
        }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1>NEON WARS</h1>
        <p>MOBILE EDITION</p>
        
        <button id="btn-continue" class="btn btn-green" onclick="loadAndStart()" style="display:none;">CONTINUE (LVL <span id="saved-lvl">0</span>)</button>
        <button class="btn" onclick="startNewGame()">START BATTLE</button>
        
        <p style="margin-top: 30px; font-size: 10px; color: #555;">LEFT: MOVE | RIGHT: SHOOT</p>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="hud">
            <div style="color:#00f3ff">SCORE: <span id="p-score">0</span></div>
            <div style="color:#f1c40f">LEVEL: <span id="p-level">1</span></div>
        </div>
        <div id="wave-msg">LEVEL 1</div>
        <div id="save-icon">ğŸ’¾</div>
        <div id="divider">MOVE | SHOOT</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        function resize() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
        }
        window.addEventListener('resize', resize); resize();

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let gameData = { level: 1, score: 0, fireRate: 20, unlockedWeapons: 1 };
        let gameRunning = false;
        let frame = 0;
        let enemies = [], bullets = [], particles = [];
        let shake = 0;
        let bossActive = false;
        const house = { x: 0, y: 60 };

        // Ù†Ø¸Ø§Ù… ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙÙ‚Ø·
        const input = {
            joystick: { active: false, startX: 0, startY: 0, x: 0, y: 0, dx: 0, dy: 0, id: null },
            fire: { active: false, x: 0, y: 0, id: null }
        };

        // --- Save System ---
        function saveGame() {
            localStorage.setItem('neonWars_mobile', JSON.stringify(gameData));
            let icon = document.getElementById('save-icon');
            icon.style.display = 'block'; setTimeout(() => icon.style.display = 'none', 1500);
        }
        function checkSaveFile() {
            let data = localStorage.getItem('neonWars_mobile');
            if(data) {
                let parsed = JSON.parse(data);
                document.getElementById('btn-continue').style.display = 'block';
                document.getElementById('saved-lvl').innerText = parsed.level;
            }
        }
        function startNewGame() {
            gameData = { level: 1, score: 0, fireRate: 20, unlockedWeapons: 1 };
            saveGame(); initLevel();
        }
        function loadAndStart() {
            let data = localStorage.getItem('neonWars_mobile');
            if(data) gameData = JSON.parse(data);
            initLevel();
        }

        // --- Game Logic ---
        class Agent {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type; this.angle = 0;
                if(type === 'player') {
                    this.radius = 20; this.color = '#00f3ff'; this.speed = 5; this.hp = 100;
                } else if (type === 'boss') {
                    this.radius = 50; this.color = '#f1c40f'; this.speed = 2 + (gameData.level * 0.1); 
                    this.hp = 150 + (gameData.level * 50);
                } else { 
                    this.radius = 20; this.color = '#ff0055'; this.speed = 3 + (gameData.level * 0.05); 
                    this.hp = 1 + Math.floor(gameData.level / 5);
                }
            }
            update(target) {
                let dx=0, dy=0;
                if (this.type === 'player') {
                    // Ø­Ø±ÙƒØ© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
                    if (input.joystick.active) { 
                        dx = input.joystick.dx; dy = input.joystick.dy; 
                        // Ø§Ù„Ø¯ÙˆØ±Ø§Ù† ÙŠØªØ¨Ø¹ Ø§Ù„Ø­Ø±ÙƒØ© Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† Ù†Ø·Ù„Ù‚ Ø§Ù„Ù†Ø§Ø±
                        if (!input.fire.active && (dx||dy)) this.angle = Math.atan2(dy, dx);
                    }
                    // Ø¥Ø·Ù„Ø§Ù‚ ÙˆØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
                    if (input.fire.active) {
                        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù† Ù„Ù…Ø³Ø© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø§Ø¹Ø¨
                        // ÙˆÙ„ÙƒÙ† Ø§Ù„Ø£ÙØ¶Ù„ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: Ø§Ù„Ù†ØµÙ Ø§Ù„Ø£ÙŠÙ…Ù† ÙŠÙˆØ¬Ù‡ ÙˆÙŠØ·Ù„Ù‚
                        // Ø³Ù†Ø¬Ø¹Ù„ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ ÙŠÙˆØ¬Ù‡ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù†Ø­Ùˆ Ù…ÙƒØ§Ù† Ø§Ù„Ù„Ù…Ø³Ø©
                        let fireAngle = Math.atan2(input.fire.y - this.y, input.fire.x - this.x);
                        this.angle = fireAngle;
                        
                        if(frame % gameData.fireRate === 0) shoot(this);
                    }
                } else {
                    let dist = Math.hypot(target.x - this.x, target.y - this.y);
                    this.angle = Math.atan2(target.y - this.y, target.x - this.x);
                    let stopDist = (this.type === 'boss') ? 200 : 120;
                    if(dist > stopDist) { dx = Math.cos(this.angle); dy = Math.sin(this.angle); }
                    else if(dist < stopDist - 50) { dx = -Math.cos(this.angle); dy = -Math.sin(this.angle); }
                    
                    enemies.forEach(other => {
                        if(other !== this && Math.hypot(this.x - other.x, this.y - other.y) < this.radius + other.radius) {
                            dx += (this.x - other.x) * 0.05; dy += (this.y - other.y) * 0.05;
                        }
                    });
                    if(Math.random() < ((this.type === 'boss') ? 0.03 : 0.02)) shoot(this);
                }
                this.x += dx * this.speed; this.y += dy * this.speed;
                this.x = Math.max(20, Math.min(width-20, this.x));
                this.y = Math.max(20, Math.min(height-20, this.y));
            }
            draw() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                ctx.shadowBlur = 15; ctx.shadowColor = this.color; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0; ctx.fillStyle = '#111';
                if(this.type === 'boss') {
                    ctx.fillRect(15, -30, 40, 60); ctx.beginPath(); ctx.arc(0, 0, 30, 0, Math.PI*2); ctx.fill();
                    let maxHp = 150 + (gameData.level * 50);
                    ctx.fillStyle = 'red'; ctx.fillRect(-40, -70, 80, 5);
                    ctx.fillStyle = '#0f0'; ctx.fillRect(-40, -70, 80 * (this.hp/maxHp), 5);
                } else {
                    ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI*2); ctx.fill(); ctx.fillRect(5, -5, 20, 10);
                }
                ctx.restore();
            }
        }

        let player;
        function spawnEnemy(type = 'enemy') {
            let e = new Agent(width/2, 100, type); enemies.push(e);
            createExplosion(e.x, 80, e.color);
        }
        function showMsg(text) {
            let el = document.getElementById('wave-msg'); el.innerText = text; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 3000);
        }
        function checkProgression() {
            let threshold = gameData.level * 25;
            if(gameData.score % threshold === 0 && !bossActive && gameData.score > 0) {
                bossActive = true; showMsg(`âš ï¸ LEVEL ${gameData.level} BOSS âš ï¸`);
                enemies = []; setTimeout(() => spawnEnemy('boss'), 1000);
            }
            let maxEnemies = 2 + Math.floor(gameData.level / 2);
            if(!bossActive && enemies.length < maxEnemies && Math.random() < 0.05) spawnEnemy();
        }
        function handleBossDeath() {
            gameData.level++; if(gameData.fireRate > 5) gameData.fireRate--;
            bossActive = false; showMsg(`LEVEL ${gameData.level} START`);
            saveGame(); document.getElementById('p-level').innerText = gameData.level;
        }
        function shoot(s) {
            let shots = [];
            if(s.type === 'boss') {
                let count = Math.min(8, 2 + Math.floor(gameData.level/2));
                for(let i=0; i<count; i++) shots.push(s.angle + (i - count/2) * 0.2);
            } else { shots.push(s.angle + (Math.random()-0.5)*0.1); }
            shots.forEach(a => { bullets.push({ x: s.x, y: s.y, vx: Math.cos(a)*12, vy: Math.sin(a)*12, color: s.color, owner: s.type === 'player' ? 'p' : 'e' }); });
        }
        function createExplosion(x, y, color) {
            shake = 10; for(let i=0; i<15; i++) particles.push({x, y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:1, color});
        }
        function drawHouse() {
            let hx = width/2 - 50; ctx.shadowBlur = 30; ctx.shadowColor = '#00f3ff'; ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(hx, house.y, 100, 60); ctx.beginPath(); ctx.moveTo(hx, house.y); ctx.lineTo(hx+50, house.y-40); ctx.lineTo(hx+100, house.y); ctx.fill();
            ctx.fillStyle = bossActive ? '#f00' : '#00f3ff'; ctx.fillRect(hx+35, house.y+20, 30, 40); ctx.shadowBlur = 0;
        }

        function initLevel() {
            document.getElementById('start-screen').style.display = 'none';
            player = new Agent(width/2, height-150, 'player');
            enemies = []; bullets = []; 
            document.getElementById('p-score').innerText = gameData.score;
            document.getElementById('p-level').innerText = gameData.level;
            showMsg(`LEVEL ${gameData.level}`);
            bossActive = false; gameRunning = true; spawnEnemy(); loop();
        }

        function loop() {
            if(!gameRunning) return;
            requestAnimationFrame(loop); frame++;
            if(shake > 0) { ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); shake *= 0.9; }

            // Ø®Ù„ÙÙŠØ©
            ctx.fillStyle = '#050505'; ctx.fillRect(0,0,width,height);
            ctx.strokeStyle = 'rgba(0, 243, 255, 0.05)'; ctx.lineWidth = 1; ctx.beginPath();
            for(let i=0; i<width; i+=60) { ctx.moveTo(i,0); ctx.lineTo(i,height); }
            for(let i=0; i<height; i+=60) { ctx.moveTo(0,i); ctx.lineTo(width,i); }
            ctx.stroke();
            drawHouse();

            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; if(p.life<=0) particles.splice(i,1);
            }

            // Ø±Ø³Ù… Ø¹ØµØ§ Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ø´ÙØ§ÙØ©)
            if (input.joystick.active) {
                // Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
                ctx.beginPath(); ctx.arc(input.joystick.startX, input.joystick.startY, 50, 0, Math.PI*2);
                ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 2; ctx.stroke();
                // Ø§Ù„Ù…Ù‚Ø¨Ø¶ Ø§Ù„Ù…ØªØ­Ø±Ùƒ
                ctx.beginPath(); ctx.arc(input.joystick.x, input.joystick.y, 25, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(0, 243, 255, 0.3)'; ctx.fill();
            }

            if(player) player.update({}); player.draw();
            enemies.forEach(e => { e.update(player); e.draw(); });

            for(let i=bullets.length-1; i>=0; i--) {
                let b = bullets[i]; b.x += b.vx; b.y += b.vy;
                ctx.strokeStyle = b.color; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(b.x-b.vx, b.y-b.vy); ctx.stroke();
                if(b.x<0||b.x>width||b.y<0||b.y>height) { bullets.splice(i,1); continue; }
                let targets = (b.owner === 'p') ? enemies : [player];
                for(let t of targets) {
                    if(Math.hypot(b.x-t.x, b.y-t.y) < t.radius+5) {
                        createExplosion(t.x, t.y, b.color);
                        if(b.owner === 'p') {
                            t.hp -= 10;
                            if(t.hp <= 0) {
                                gameData.score++; document.getElementById('p-score').innerText = gameData.score;
                                createExplosion(t.x, t.y, '#fff');
                                if(t.type === 'boss') { enemies = enemies.filter(e => e !== t); handleBossDeath(); }
                                else { t.x = width/2; t.y = 80; t.hp = 1 + Math.floor(gameData.level/5); checkProgression(); }
                            }
                        }
                        bullets.splice(i,1); break;
                    }
                }
            }
            ctx.restore();
        }

        // --- Touch Event Listeners (FIXED FOR START BUTTON) ---
        
        window.addEventListener('touchstart', e => {
            // Ù„Ø§ Ù†Ù…Ù†Ø¹ Ø§Ù„Ù€ default Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‡Ø¯Ù Ø²Ø±
            if(e.target.tagName !== 'BUTTON') {
                e.preventDefault(); 
            }
            
            for(let i=0; i<e.changedTouches.length; i++) {
                let t = e.changedTouches[i];
                // Ø§Ù„Ù†ØµÙ Ø§Ù„Ø£ÙŠØ³Ø±: Ø­Ø±ÙƒØ©
                if(t.clientX < width / 2) {
                    input.joystick.active = true;
                    input.joystick.id = t.identifier;
                    input.joystick.startX = t.clientX; input.joystick.startY = t.clientY;
                    input.joystick.x = t.clientX; input.joystick.y = t.clientY;
                    input.joystick.dx = 0; input.joystick.dy = 0;
                } 
                // Ø§Ù„Ù†ØµÙ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø¥Ø·Ù„Ø§Ù‚
                else {
                    input.fire.active = true;
                    input.fire.id = t.identifier;
                    input.fire.x = t.clientX; input.fire.y = t.clientY;
                    if(gameRunning && player) shoot(player); // Ø·Ù„Ù‚Ø© ÙÙˆØ±ÙŠØ©
                }
            }
        }, {passive: false});

        window.addEventListener('touchmove', e => {
            if(e.target.tagName !== 'BUTTON') e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++) {
                let t = e.changedTouches[i];
                // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹ØµØ§
                if(input.joystick.active && t.identifier === input.joystick.id) {
                    let dx = t.clientX - input.joystick.startX;
                    let dy = t.clientY - input.joystick.startY;
                    let dist = Math.min(50, Math.hypot(dx, dy));
                    let angle = Math.atan2(dy, dx);
                    
                    input.joystick.x = input.joystick.startX + Math.cos(angle) * dist;
                    input.joystick.y = input.joystick.startY + Math.sin(angle) * dist;
                    
                    input.joystick.dx = Math.cos(angle) * (dist/50);
                    input.joystick.dy = Math.sin(angle) * (dist/50);
                }
                // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ØªØµÙˆÙŠØ¨
                if(input.fire.active && t.identifier === input.fire.id) {
                    input.fire.x = t.clientX; input.fire.y = t.clientY;
                }
            }
        }, {passive: false});

        window.addEventListener('touchend', e => {
             if(e.target.tagName !== 'BUTTON') e.preventDefault();
             for(let i=0; i<e.changedTouches.length; i++) {
                let t = e.changedTouches[i];
                if(t.identifier === input.joystick.id) {
                    input.joystick.active = false; input.joystick.dx = 0; input.joystick.dy = 0;
                }
                if(t.identifier === input.fire.id) input.fire.active = false;
             }
        }, {passive: false});
        
        checkSaveFile();
    </script>
</body>
</html>
