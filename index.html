<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON WARS: Double Trouble</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Orbitron', sans-serif; }
        canvas { display: block; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 10, 0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; pointer-events: auto; z-index: 100;
        }
        
        h1 { color: #00f3ff; text-shadow: 0 0 20px #00f3ff; font-size: 40px; text-align: center; margin: 0; }
        p { color: #aaa; margin-top: 5px; font-size: 14px; text-align: center; max-width: 80%; }

        .btn {
            background: transparent; border: 2px solid #00f3ff; color: #00f3ff;
            padding: 15px 40px; font-size: 18px; font-family: 'Orbitron', sans-serif;
            cursor: pointer; margin-top: 30px; text-transform: uppercase;
            box-shadow: 0 0 10px #00f3ff; animation: pulse 1s infinite alternate;
        }
        .btn:active { background: #00f3ff; color: #000; }
        
        @keyframes pulse { from { box-shadow: 0 0 10px #00f3ff; } to { box-shadow: 0 0 20px #00f3ff, 0 0 40px #00f3ff; } }

        #hud { padding: 15px; display: flex; justify-content: space-between; width: 90%; margin: 0 auto; text-shadow: 0 2px 5px rgba(0,0,0,0.8); font-size: 18px; font-weight: bold; }
        
        #wave-msg {
            position: absolute; top: 20%; width: 100%; text-align: center;
            color: #f1c40f; font-size: 30px; font-weight: bold; opacity: 0; transition: opacity 0.5s; text-shadow: 0 0 10px red;
        }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1>NEON WARS</h1>
        <p>PHASE 1: SURVIVE<br>PHASE 2: THE TWINS</p>
        <button class="btn" onclick="startGame()">START BATTLE</button>
    </div>

    <div id="win-screen" class="screen" style="display:none;">
        <h1 style="color:#f1c40f">VICTORY!</h1>
        <p>YOU DEFEATED THE TWIN BOSSES</p>
        <p>SCORE: <span id="final-score">0</span></p>
        <!-- ضع رابط الجزء الثاني هنا -->
        <a id="next-game-link" href="#" target="_blank">
            <button class="btn">GET PART 2</button>
        </a>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="hud">
            <div style="color:#00f3ff">SCORE: <span id="p-score">0</span></div>
            <div style="color:#ff0055">BOSSES: <span id="boss-count">0</span></div>
        </div>
        <div id="wave-msg">WARNING!</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        function resize() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
        }
        window.addEventListener('resize', resize); resize();

        let gameRunning = false;
        let score = 0;
        let fireRate = 20;
        let frame = 0;
        
        let enemies = [];
        let bullets = [];
        let particles = [];
        let shake = 0;
        
        // نظام المراحل (Phase System)
        // 0: عادي | 1: وحش واحد | 2: وحشين
        let bossPhase = 0; 
        
        const house = { x: 0, y: 60 }; 

        const input = {
            joystick: { active: false, x: 0, y: 0, dx: 0, dy: 0, id: null },
            fireBtn: { active: false, x: 0, y: 0, id: null },
            keys: { w:false, a:false, s:false, d:false },
            mouse: { x: 0, y: 0, down: false },
            isMobile: false
        };

        class Agent {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type; 
                this.angle = 0;
                
                if(type === 'player') {
                    this.radius = 20; this.color = '#00f3ff'; this.speed = 4.5; this.hp = 100;
                } else if (type === 'boss') {
                    this.radius = 45; this.color = '#f1c40f'; this.speed = 3; this.hp = 200; // 200 HP للوحش
                } else { 
                    this.radius = 20; this.color = '#ff0055'; this.speed = 3.5; this.hp = 1;
                }
            }

            update(target) {
                let dx=0, dy=0;
                if (this.type === 'player') {
                    if (input.joystick.active) { dx = input.joystick.dx; dy = input.joystick.dy; }
                    else {
                        if(input.keys.w) dy = -1; if(input.keys.s) dy = 1;
                        if(input.keys.a) dx = -1; if(input.keys.d) dx = 1;
                    }
                    if (input.isMobile) { if(dx||dy) this.angle = Math.atan2(dy, dx); }
                    else {
                        this.angle = Math.atan2(input.mouse.y - this.y, input.mouse.x - this.x);
                        if(input.mouse.down && frame % fireRate === 0) shoot(this);
                    }
                    if (input.isMobile && input.fireBtn.active && frame % fireRate === 0) shoot(this);

                } else {
                    // ذكاء الأعداء
                    let dist = Math.hypot(target.x - this.x, target.y - this.y);
                    this.angle = Math.atan2(target.y - this.y, target.x - this.x);
                    
                    // الوحوش تبتعد قليلاً لكي لا تلتصق باللاعب
                    let stopDist = (this.type === 'boss') ? 200 : 120;
                    
                    if(dist > stopDist) { dx = Math.cos(this.angle); dy = Math.sin(this.angle); }
                    else if(dist < stopDist - 50) { dx = -Math.cos(this.angle); dy = -Math.sin(this.angle); }
                    
                    // تفادي التصادم بين الوحوش (Separation)
                    enemies.forEach(other => {
                        if(other !== this) {
                            let d = Math.hypot(this.x - other.x, this.y - other.y);
                            if(d < this.radius + other.radius) {
                                dx += (this.x - other.x) / d;
                                dy += (this.y - other.y) / d;
                            }
                        }
                    });

                    let shootProb = (this.type === 'boss') ? 0.04 : 0.02;
                    if(Math.random() < shootProb) shoot(this);
                }
                this.x += dx * this.speed; this.y += dy * this.speed;
                this.x = Math.max(20, Math.min(width-20, this.x));
                this.y = Math.max(20, Math.min(height-20, this.y));
            }

            draw() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                ctx.shadowBlur = 15; ctx.shadowColor = this.color;
                ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fill();
                
                ctx.shadowBlur = 0; ctx.fillStyle = '#111';
                if(this.type === 'boss') {
                    // شكل مخيف للوحش
                    ctx.fillRect(15, -30, 40, 10); ctx.fillRect(15, 20, 40, 10); // 4 أسلحة
                    ctx.fillRect(15, -10, 50, 20); // مدفع رئيسي
                    ctx.beginPath(); ctx.arc(0, 0, 25, 0, Math.PI*2); ctx.fill();
                    // شريط حياة فوق الوحش
                    ctx.fillStyle = 'red'; ctx.fillRect(-30, -60, 60, 5);
                    ctx.fillStyle = '#0f0'; ctx.fillRect(-30, -60, 60 * (this.hp/200), 5);
                } else {
                    ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI*2); ctx.fill();
                    ctx.fillRect(5, -5, 20, 10);
                }
                ctx.restore();
            }
        }

        let player;

        function spawnEnemy(type = 'enemy', offsetX = 0) {
            let e = new Agent(width/2 + offsetX, 100, type);
            enemies.push(e);
            createExplosion(e.x, 80, e.color);
        }

        function showMsg(text) {
            let el = document.getElementById('wave-msg');
            el.innerText = text; el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 4000);
        }

        function checkProgression() {
            // تحديث واجهة الوحوش
            let bossCount = enemies.filter(e => e.type === 'boss').length;
            document.getElementById('boss-count').innerText = bossCount;

            // زيادة سرعة السلاح
            if(score % 15 === 0) {
                let newRate = 20 - Math.floor(score/20); 
                fireRate = Math.max(4, newRate);
            }

            // المرحلة 1: ظهور الوحش الأول (عند 100 نقطة)
            if(score >= 100 && bossPhase === 0) {
                bossPhase = 1;
                showMsg("⚠️ BOSS DETECTED ⚠️");
                enemies = []; // قتل الصغار
                setTimeout(() => spawnEnemy('boss'), 1000);
            }
            
            // إعادة تعبئة الأعداء العاديين إذا لم يكن هناك وحش
            if(bossPhase === 0 && enemies.length < 2) {
                if(Math.random() < 0.05) spawnEnemy();
            }
        }

        function handleBossDeath() {
            // إذا كنا في المرحلة 1 ومات الوحش (النتيجة حوالي 200)
            if(bossPhase === 1) {
                bossPhase = 2;
                showMsg("⚠️ DOUBLE THREAT! ⚠️");
                score += 50; // بونص
                // ظهور وحشين!
                setTimeout(() => {
                    spawnEnemy('boss', -60); // يسار
                    spawnEnemy('boss', 60);  // يمين
                }, 1500);
            }
            // إذا كنا في المرحلة 2 (الوحشين)
            else if(bossPhase === 2) {
                let bossesLeft = enemies.filter(e => e.type === 'boss').length;
                score += 100;
                if(bossesLeft === 0) {
                    // الفوز النهائي
                    setTimeout(() => {
                        gameRunning = false;
                        document.getElementById('final-score').innerText = score;
                        document.getElementById('win-screen').style.display = 'flex';
                    }, 1000);
                }
            }
        }

        function shoot(s) {
            let shots = [];
            if(s.type === 'boss') {
                // الوحش يطلق في 3 اتجاهات
                shots.push(s.angle);
                shots.push(s.angle - 0.3);
                shots.push(s.angle + 0.3);
            } else {
                shots.push(s.angle + (Math.random()-0.5)*0.1);
            }
            shots.forEach(a => {
                bullets.push({
                    x: s.x, y: s.y, vx: Math.cos(a)*12, vy: Math.sin(a)*12, 
                    color: s.color, owner: s.type === 'player' ? 'p' : 'e'
                });
            });
        }

        function createExplosion(x, y, color) {
            shake = 15;
            for(let i=0; i<20; i++) particles.push({x, y, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12, life:1, color});
        }

        function drawHouse() {
            let hx = width/2 - 50;
            ctx.shadowBlur = 30; ctx.shadowColor = '#00f3ff';
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(hx, house.y, 100, 60);
            ctx.beginPath(); ctx.moveTo(hx, house.y); ctx.lineTo(hx+50, house.y-40); ctx.lineTo(hx+100, house.y); ctx.fill();
            // البوابة
            ctx.fillStyle = (bossPhase > 0) ? '#f00' : '#00f3ff';
            ctx.fillRect(hx+30, house.y+20, 40, 40);
            ctx.shadowBlur = 0;
        }

        // Loop
        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            player = new Agent(width/2, height-150, 'player');
            enemies = []; bullets = []; score = 0; bossPhase = 0;
            spawnEnemy();
            gameRunning = true; loop();
        }

        function loop() {
            if(!gameRunning) return;
            requestAnimationFrame(loop);
            frame++;

            if(shake > 0) { ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); shake *= 0.9; }

            // خلفية
            ctx.fillStyle = '#050505'; ctx.fillRect(0,0,width,height);
            ctx.strokeStyle = 'rgba(0, 243, 255, 0.05)'; ctx.lineWidth = 1; ctx.beginPath();
            for(let i=0; i<width; i+=60) { ctx.moveTo(i,0); ctx.lineTo(i,height); }
            for(let i=0; i<height; i+=60) { ctx.moveTo(0,i); ctx.lineTo(width,i); }
            ctx.stroke();

            drawHouse();

            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1; if(p.life<=0) particles.splice(i,1);
            }

            if (input.isMobile) {
                if (input.joystick.active) {
                    ctx.beginPath(); ctx.arc(input.joystick.x, input.joystick.y, 40, 0, Math.PI*2);
                    ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.stroke();
                    ctx.beginPath(); ctx.arc(input.joystick.x + input.joystick.dx*40, input.joystick.y + input.joystick.dy*40, 20, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(0, 243, 255, 0.5)'; ctx.fill();
                }
                if (input.fireBtn.active) {
                    ctx.beginPath(); ctx.arc(input.fireBtn.x, input.fireBtn.y, 35, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(255, 0, 85, 0.5)'; ctx.fill();
                }
            }

            if(player) player.update({});
            player.draw();

            enemies.forEach(e => { e.update(player); e.draw(); });

            for(let i=bullets.length-1; i>=0; i--) {
                let b = bullets[i]; b.x += b.vx; b.y += b.vy;
                ctx.strokeStyle = b.color; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(b.x-b.vx, b.y-b.vy); ctx.stroke();

                if(b.x<0||b.x>width||b.y<0||b.y>height) { bullets.splice(i,1); continue; }

                let targets = (b.owner === 'p') ? enemies : [player];
                
                for(let t of targets) {
                    if(Math.hypot(b.x-t.x, b.y-t.y) < t.radius+5) {
                        createExplosion(t.x, t.y, b.color);
                        if(b.owner === 'p') {
                            t.hp -= 10;
                            if(t.hp <= 0) {
                                score++; 
                                createExplosion(t.x, t.y, '#fff'); // انفجار كبير
                                if(t.type === 'boss') {
                                    // إذا مات وحش، نحذفه من المصفوفة
                                    enemies = enemies.filter(e => e !== t);
                                    handleBossDeath(); // التحقق هل نخرج الوحشين؟
                                } else {
                                    t.x = width/2; t.y = 80; t.hp = 1; // تدوير العدو العادي
                                }
                                checkProgression();
                            }
                        }
                        bullets.splice(i,1); break;
                    }
                }
            }

            document.getElementById('p-score').innerText = score;
            ctx.restore();
        }

        // Inputs (نفس السابق)
        window.addEventListener('touchstart', e => { e.preventDefault(); input.isMobile = true; for(let i=0; i<e.changedTouches.length; i++){ let t = e.changedTouches[i]; if(t.clientX < width/2){ input.joystick.active = true; input.joystick.id = t.identifier; input.joystick.x = t.clientX; input.joystick.y = t.clientY; } else { input.fireBtn.active = true; input.fireBtn.id = t.identifier; input.fireBtn.x = t.clientX; input.fireBtn.y = t.clientY; } } }, {passive: false});
        window.addEventListener('touchmove', e => { e.preventDefault(); for(let i=0; i<e.changedTouches.length; i++){ let t = e.changedTouches[i]; if(input.joystick.active && t.identifier === input.joystick.id){ let dx = t.clientX - input.joystick.x, dy = t.clientY - input.joystick.y; let dist = Math.min(50, Math.hypot(dx, dy)); let ang = Math.atan2(dy, dx); input.joystick.dx = (Math.cos(ang)*dist)/50; input.joystick.dy = (Math.sin(ang)*dist)/50; } if(input.fireBtn.active && t.identifier === input.fireBtn.id){ input.fireBtn.x = t.clientX; input.fireBtn.y = t.clientY; } } }, {passive: false});
        window.addEventListener('touchend', e => { e.preventDefault(); for(let i=0; i<e.changedTouches.length; i++){ if(e.changedTouches[i].identifier === input.joystick.id){ input.joystick.active = false; input.joystick.dx=0; input.joystick.dy=0; } if(e.changedTouches[i].identifier === input.fireBtn.id) input.fireBtn.active = false; } }, {passive: false});
        window.addEventListener('keydown', e => { let k=e.key.toLowerCase(); if(k==='w')input.keys.w=true; if(k==='s')input.keys.s=true; if(k==='a')input.keys.a=true; if(k==='d')input.keys.d=true; });
        window.addEventListener('keyup', e => { let k=e.key.toLowerCase(); if(k==='w')input.keys.w=false; if(k==='s')input.keys.s=false; if(k==='a')input.keys.a=false; if(k==='d')input.keys.d=false; });
        window.addEventListener('mousemove', e => { input.mouse.x = e.clientX; input.mouse.y = e.clientY; });
        window.addEventListener('mousedown', () => input.mouse.down = true);
        window.addEventListener('mouseup', () => input.mouse.down = false);
    </script>
</body>
</html>
